{% extends 'blog/resources.html' %}
{% load staticfiles %}
     
{% block content %}
     <!-- blog starts -->
     <div class="row-fluid">
        <div class="span12">
            <h1 class="line">Map of Africa and India</h1>
        </div>
        <div class="row-fluid">
            <div class="span9" id="map" style="width:100%;height:600px;">
                <!-- <iframe width='100%' height='600'></iframe> -->
            </div>

            {% block minimenu %}
                {{ block.super }}
            {% endblock %}

        </div>

    <div id='output'>
        mousemove: <code id='mousemove'></code><br/>
    </div>
       
    <script src='//api.tiles.mapbox.com/mapbox.js/v1.6.0/mapbox.js'></script>   


    <script>
        var mousemove = document.getElementById('mousemove');

        var map = L.mapbox.map('map', 'nathanfloor.gi77fl7c');

        map.on('mousemove', function(e) {
            window[e.type].innerHTML = e.containerPoint.toString() + ', ' + e.latlng.toString();
        });

        var markers = {{ markers_list|safe }};
        var features = [];

        console.log(markers[0]);


        for (var i = 0; i <= markers.length - 1; i++) {
            //loading markers into geojson format to be loaded onto map
            loadMarkersIntoGeoJSON(markers[i])
        };

        //saves json into geoJSON
        function loadMarkersIntoGeoJSON(marker){
            var temp = marker.fields.coordinates.split(",");
            var x = temp[0];
            var y = temp[1];
            var date_added = marker.fields.date_added.split("T")[0];

            features.push({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [x,y]
                },
                properties: {
                    'marker-color': '#000',
                    'marker-symbol': 'star-stroked',
                    'title': marker.fields.name_of_region,
                    'images': '/media/'+marker.fields.thumbnail,
                    'url': marker.fields.external_link,
                    'description': marker.fields.description,
                    'date_added': date_added
                }
            });
        }

        //display marker icon on map
        function loadMarkersIntoGeoJSON(marker){
            var marker = L.marker([x, y], {
                icon: L.mapbox.marker.icon({
                    // this feature is in the GeoJSON format: see geojson.org
                    // for the full specification
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        // coordinates here are in longitude, latitude order because
                        // x, y is the standard for GeoJSON and many formats
                        coordinates: [x, y]
                    },
                    properties: {
                        'marker-color': '#000',
                        'marker-symbol': 'star-stroked',
                        'title': marker.fields.name_of_region,
                        'images': '/media/'+marker.fields.thumbnail,
                        'url': marker.fields.external_link,
                        'description': marker.fields.description,
                        'date_added': date_added
                    }
                })
            });
            

            marker.addTo(map);
        }

        // Add custom popup html to each marker
        map.markerLayer.on('layeradd', function(e) {
            var marker = e.layer;
            var feature = marker.feature;
            var image = feature.properties.images
            var content = '';

            content += '<div class="image' + (i === 0 ? ' active' : '') + '">' +
                                      '<img src="' + image + '" />'
                                    '</div>';
            

            // Create custom popup content
            var popupContent =  '<div id="' + feature.properties.id + '" class="popup">' +
                                    '<h2><a href= http://' + feature.properties.url + '>' + feature.properties.title + '</a></h2>' +
                                    '<div class="slideshow">' +
                                        content +
                                    '</div>' +
                                    '<p>' + feature.properties.description + '</p>' +
                                    '<p>Date Added: ' + feature.properties.date_added + '</p>'
                                '</div>';

            // console.log(feature.properties.date_added);

            marker.bindPopup(popupContent,{
                closeButton: false,
                minWidth: 320
            });
        });


        //load geoJSON data onto map
        map.markerLayer.setGeoJSON({
            type: 'FeatureCollection',
            features: features
        });
        map.setView([47, -77], 5);
        
        // // center map to marker when clicked
        // map.markerLayer.on('click', function(e) {
        //     map.panTo(e.layer.getLatLng());
        // });

    </script>

{% endblock %}
